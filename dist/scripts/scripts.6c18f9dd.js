"use strict";angular.module("mindmapModule",[]),angular.module("mindmapViewApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","mindmapModule"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MindmapCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("mindmapModule").factory("MindMap",[function(){function a(a){a?(this.id=a.id||null,this.name=a.name||null,this.root=a.root||null):(this.id=null,this.name=null,this.root=null)}return a}]),angular.module("mindmapModule").factory("Node",["Utils",function(a){function b(a){a?(this.x=a.x,this.y=a.y,this.width=a.width,this.height=a.height):(this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0)}function c(c){c?(this.id=c.id,this.value=c.value,this.children=c.children,this.position=new b(c.position),this.parentId=c.parentId):(this.id=a.uuid(),this.value=void 0,this.children=[],this.position=new b,this.parentId=void 0)}return c.prototype={getId:function(){return this.id},getValue:function(){return this.value},getChildren:function(){return this.children},getPosition:function(){return this.position},setPosition:function(a){this.position=new b(a)}},c}]),angular.module("mindmapModule").service("IndexedDBProvider",["$q",function(a){!1 in window&&(window.indexedDB=window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB),window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.mozIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange||window.msIDBKeyRange;var b,c=1,d={};d.db=null;var e=function(){var e=a.defer();return b=b||window.indexedDB.open("MindMapDataBase",c),b.onerror=function(a){console.log("database error number : "+a.target.errorCode)},b.onsuccess=function(a){d.db=a.target.result,e.resolve()},b.onupgradeneeded=function(a){d.db=a.target.result,d.db.createObjectStore("mindmap",{keyPath:"id"})},e.promise},f=function(a){var b=d.db.transaction([a],"readwrite");return b.oncomplete=function(){console.log("transaction done without error")},b.onerror=function(){console.log("transaction on error ")},b};e(),this.save=function(a){if(d.db){var b=f("mindmap").objectStore("mindmap");b.add(a)}else e().then(function(){{var b=f("mindmap").objectStore("mindmap");b.add(a)}})},this.get=function(b){var c=a.defer();if(d.db){var g=f("mindmap").objectStore("mindmap"),h=g.get(b);h.onsuccess=function(a){c.resolve(a.target.result)}}else e().then(function(){var a=f("mindmap").objectStore("mindmap"),d=a.get(b);d.onsuccess=function(a){c.resolve(a.target.result)}});return c.promise},this.update=function(a){if(d.db){var b=f("mindmap").objectStore("mindmap");b.put(a)}else e().then(function(){var b=f("mindmap").objectStore("mindmap");b.put(a)})},this.getAll=function(){var b=a.defer();if(d.db){var c=f("mindmap").objectStore("mindmap"),g=window.IDBKeyRange.lowerBound(0),h=c.openCursor(g),i=[];h.onsuccess=function(a){var c=a.target.result;c&&c!==!1?(i.push(c.value),c.continue()):b.resolve(i)}}else e().then(function(){var a=f("mindmap").objectStore("mindmap"),c=window.IDBKeyRange.lowerBound(0),d=a.openCursor(c),e=[];d.onsuccess=function(a){var c=a.target.result;c&&c!==!1?(e.push(c.value),c.continue()):b.resolve(e)}});return b.promise}}]),angular.module("mindmapModule").service("StorageProvider",["IndexedDBProvider",function(a){this.get=function(b){return a.get(b)},this.save=function(b){a.save(b)},this.update=function(b){a.update(b)},this.getAll=function(){return a.getAll()}}]),angular.module("mindmapModule").service("StorageService",["StorageProvider",function(a){this.get=function(b){return a.get(b)},this.save=function(b){a.save(b)},this.update=function(b){a.update(b)},this.getAll=function(){return a.getAll()}}]),angular.module("mindmapModule").service("MindmapService",["$q","Utils","Node","MindMap","StorageService",function(a,b,c,d,e){this.create=function(a){var d=new c;return a&&(d=new c,d.id=b.uuid(),d.parentId=a),d},this.createMindMap=function(a){var e=new d({name:a});return e.id=b.uuid(),e.root=new c,e},this.saveMindMap=function(a){e.save(a)},this.getAllMindMap=function(){var b=a.defer(),c=e.getAll();return c.then(function(a){var c=[];a.forEach(function(a){c.push(new d(a))}),b.resolve(c)}),b.promise},this.getMindMap=function(b){var c=a.defer(),f=e.get(b);return f.then(function(a){c.resolve(new d(a))}),c.promise},this.saveMindMap=function(a){e.update(a)},this.save=function(a){a.id?e.update(a):(a.id=b.uuid(),e.save(a))},this.get=function(b){var d=a.defer(),f=e.get(b);return f.then(function(a){d.resolve(new c(a))}),d.promise}}]);var CLASS_SVG_CONTAINER=".js-svg-container",SNAP_SVG,TREE_STRUCTURE,MINDMAP_CTRL,_calculRootPosition=function(a){return{x:10,y:a[0]&&a[0].clientHeight?a[0].clientHeight/2:150,height:25,width:250}},_createTreeStructure=function(a,b,c){var d={node:a,position:a.position,parent:b||a,nextNodeId:null,previousNodeId:c,leaf:!0};if(TREE_STRUCTURE||(TREE_STRUCTURE={},TREE_STRUCTURE.links=[]),a){if(TREE_STRUCTURE[a.id]={structure:d,children:[]},b){var e=TREE_STRUCTURE[b.id];e&&-1===_.indexOf(e.children,a.id)&&(e.children.push(a.id),e.structure.leaf=!1);var f=c&&TREE_STRUCTURE[c]?TREE_STRUCTURE[c]:null;f&&(TREE_STRUCTURE[c].structure.nextNodeId=a.id)}var g=_.countBy(TREE_STRUCTURE,function(a){return a.structure&&a.structure.leaf});d.position.y=35*g.true,a.children.forEach(function(b){_createTreeStructure(b,a,a.id)})}},_walkThruTree=function(){_.map(TREE_STRUCTURE,function(a){if(a.children&&a.children.length>0){var b=a.structure.position;a.children.forEach(function(a){var c=TREE_STRUCTURE[a],d=c.structure.position;d.x=d.x||b.x+b.width+100,d.width=d.width||250,d.height=d.height||25})}});var a,b,c,d=_.filter(TREE_STRUCTURE,function(a){return a.children&&a.children.length>0});d.forEach(function(d){a=0,d.children.forEach(function(b){c=TREE_STRUCTURE[b].structure,c&&(a+=c.position.y)}),b=a/d.children.length,d.structure.position.y=b})},_findLastDescendant=function(a){var b,c=TREE_STRUCTURE[a];return c&&(c&&c.children.length>0&&(b=c.children[c.children.length-1]),b&&TREE_STRUCTURE[b].children.length>0)?_findLastDescendant(b):b},_calculateNewChildPosition=function(a){return TREE_STRUCTURE[a.id].structure.position},_calculatePathPosition=function(a,b){var c=TREE_STRUCTURE[a]?TREE_STRUCTURE[a].structure.position:null,d=TREE_STRUCTURE[b]?TREE_STRUCTURE[b].structure.position:null,e=c?c.x+c.width:0,f=c?c.y+c.height/2:0,g=d?d.x:0,h=d?d.y+d.height/2:0,i="M"+e+","+f+"C"+(e+100)+" "+f+" "+(g-100)+" "+h+" "+g+" "+h+"M"+g+","+h+"L"+(g-10)+","+(h-5)+"M"+g+","+h+"L"+(g-10)+","+(h+5);return i},_updatePathPosition=function(){var a,b=SNAP_SVG.selectAll("path");_.each(b,function(b){a=JSON.parse(b.attr("data")),b.attr({d:_calculatePathPosition(a.sourceId,a.targetId)})})},_navigateThruTree=function(a,b){var c=TREE_STRUCTURE[a],d=c.structure.parent,e=d.children.indexOf(c.structure.node);if("up"===b){if(e>0)return d.children[e-1]?d.children[e-1].id:null}else if("down"===b&&e<d.children.length)return d.children[e+1]?d.children[e+1].id:null},_getElement=function(a){return SNAP_SVG.select('g[node-id="'+a+'"]')};angular.module("mindmapModule").directive("mindMapSvg",["$compile","MindmapService","KeyboardUtils",function(a,b,c){function d(a){return this.createNewChild=function(b){var c=e(b);return b.children.push(c),TREE_STRUCTURE=null,_createTreeStructure(a.root),_walkThruTree(),c.position=_calculateNewChildPosition(c),_updatePathPosition(),a.lastBorn=c.id,a.$digest(),c.id},this.getLastBornId=function(){return a.lastBorn},this.createNewBrother=function(a){return a?this.createNewChild(TREE_STRUCTURE[a].structure.node):void 0},this.navigateThruMap=function(a,b){return _navigateThruTree(a.id,b)},this.saveMindMap=function(){b.saveMindMap(a.mindmap)},this.getTreeStructure=function(){return TREE_STRUCTURE},this.getPathPosition=function(a,b){return _calculatePathPosition(a,b)},this.setSelectedNodeId=function(b){a.selectedNodeId=b,a.$digest()},this.getSelectedNodeId=function(){return a.selectedNodeId||a.root.id},this}var e=function(a){var c=b.create(a.id);return c},f={restrict:"AE",replace:!0,templateNamespace:"svg",scope:{mindmapid:"=attrMindMap"},templateUrl:"/templates/template-mindmap.html",controller:function(a,c){var d=b.getMindMap(a.mindmapid);d.then(function(b){a.mindmap=b,a.root=b.root,a.root.position=_calculRootPosition(c.find("svg")),_createTreeStructure(a.root),_walkThruTree()}),this.setSelectedNodeId=function(a){MINDMAP_CTRL.setSelectedNodeId(a)},this.getLastBornId=function(){return MINDMAP_CTRL.getLastBornId()},this.saveMindMap=function(){b.saveMindMap(a.mindmap)},this.getPathPosition=function(a,b){return _calculatePathPosition(a,b)}},link:function(a){SNAP_SVG=Snap(document.querySelector(CLASS_SVG_CONTAINER)),SNAP_SVG.select("g").drag(),a.$watch("selectedNodeId",function(b,c){if(b!==c){var d=_getElement(b),e=_getElement(c?c:a.root.id);e&&(e[0].removeClass("active"),e[1].removeClass("active")),d&&(d[0].addClass("active"),d[1].addClass("active"))}}),angular.element(document.querySelector("body")).on("keydown",function(a){if("input"!==a.target.tagName.toLowerCase()){a.preventDefault();var b=TREE_STRUCTURE[MINDMAP_CTRL.getSelectedNodeId()].structure.node;c[a.which]===c.keys.tab?MINDMAP_CTRL.setSelectedNodeId(MINDMAP_CTRL.createNewChild(b)):c[a.which]===c.keys.enter?MINDMAP_CTRL.setSelectedNodeId(MINDMAP_CTRL.createNewBrother(b.parentId)):a.which>36&&a.which<41&&MINDMAP_CTRL.setSelectedNodeId(MINDMAP_CTRL.navigateThruMap(b,c[a.which]))}}),MINDMAP_CTRL=MINDMAP_CTRL||new d(a)}};return f}]);var XMLNS_URL="http://www.w3.org/2000/svg",CLASS_CONTAINER=".js-mindmap-container",CLASS_SVG_CONTAINER=".js-svg-container",CONTAINER=document.querySelector(CLASS_CONTAINER),SNAP_SVG,SNAP_FIRST_GROUP,_createSVGNode=function(){var a=SNAP_SVG.rect().addClass("mindmap-rectangle"),b=SNAP_SVG.text().addClass("mindmap-text"),c=SNAP_SVG.group(a,b);return c.attr("node-id","{{node.id}}"),a.attr({x:"{{node.position.x}}",y:"{{node.position.y}}",width:"{{node.position.width}}",height:"{{node.position.height}}",ry:3,rx:3}),b.attr({x:"{{node.position.x + 10}}",y:"{{node.position.y + node.position.height/2+ 3}}",text:"{{node.value}}"}),c},_createNodePopUp=function(a){var b=angular.element('<ng-pop-up-input node-value="node.value" save="save()"/>'),c=a.getBBox(),d=SNAP_FIRST_GROUP.getBBox(),e=a.node.nearestViewportElement;return b.css({top:d.y+c.y+e.offsetTop+"px",left:d.x+c.x+e.offsetLeft+"px",width:"300px",height:"25px",position:"absolute"}),b};angular.module("mindmapModule").directive("ngRectangleComponent",["$compile","$interpolate","$timeout",function(a,b,c){return{restrict:"AE",replace:!0,templateNamespace:"g",scope:{node:"=mindMapNode",lastBorn:"@lastBorn"},require:"^mindMapSvg",link:{pre:function(d,e,f,g){d.save=function(){g.saveMindMap()},CONTAINER=document.querySelector(CLASS_CONTAINER),SNAP_SVG=Snap(document.querySelector(CLASS_SVG_CONTAINER)),SNAP_FIRST_GROUP=SNAP_SVG.select("g:first-child");var h=_createSVGNode(b,d);h.mouseover(function(){g.setSelectedNodeId(d.node.id)}),h.dblclick(function(){angular.element(CONTAINER).append(a(_createNodePopUp(this[0]))(d))}),SNAP_FIRST_GROUP.append(h),a(h.node)(d),c(function(){d.$parent.$last&&d.node&&d.node.id===g.getLastBornId()&&(angular.element(CONTAINER).append(a(_createNodePopUp(h[0]))(d)),g.setSelectedNodeId(d.node.id))})},post:function(b,c){c.append(a('<ng-rectangle-component node-id={{child.id}} mind-map-node="child" ng-repeat="child in node.children"/>')(b)),c.append(a('<ng-path-component source="{{node.id}}" target="{{child.id}}" ng-repeat="child in node.children"/>')(b))}}}}]);var CLASS_SVG_CONTAINER=".js-svg-container",SNAP_SVG,SNAP_FIRST_GROUP;angular.module("mindmapModule").directive("ngPathComponent",["$compile","$interpolate",function(a){return{restrict:"AE",replace:!0,templateNamespace:"path",scope:{source:"@source",target:"@target"},require:"^mindMapSvg",link:{pre:function(b,c,d,e){SNAP_SVG=SNAP_SVG||Snap(document.querySelector(CLASS_SVG_CONTAINER)),SNAP_FIRST_GROUP=SNAP_FIRST_GROUP||SNAP_SVG.select("g:first-child");var f=SNAP_SVG.path(e.getPathPosition(b.source,b.target)).attr({data:JSON.stringify({sourceId:"{{source}}",targetId:"{{target}}"})}).addClass("mindmap-path");SNAP_FIRST_GROUP.append(f),a(f.node)(b)}}}}]),angular.module("mindmapModule").directive("ngPopUpInput",["$compile","KeyboardUtils",function(a,b){return{restrict:"AE",replace:!0,scope:{text:"=nodeValue",save:"&"},templateUrl:"/templates/components/pop-up-input.html",link:function(a,c){a.text;c[0].focus(),c.bind("blur",function(){c.unbind("blur"),c.remove(),a.save()}),c.bind("keydown",function(d){(b[d.which]===b.keys.enter||b[d.which]===b.keys.esc)&&(c.unbind("keydown"),c.remove(),a.save())})}}}]),angular.module("mindmapModule").controller("MindmapCtrl",["$scope","$compile","MindmapService",function(a,b,c){var d=function(){c.getAllMindMap().then(function(b){a.mindmaps=b})};a.createMindMap=function(b,e){console.log("create here a new mindmap ");var f=c.createMindMap(e);c.saveMindMap(f),d(),a.selectedMindmap=f.id,a.loadMindMap(f.id)},a.loadMindMap=function(c){a.rootId=c;var d=document.querySelector(".js-controller"),e=document.querySelector(".js-mindmap-container"),f=angular.element('<mind-map-svg attr-mind-map="rootId"/>'),g=b(f),h=g(a);e?angular.element(e).replaceWith(h):angular.element(d).append(h)},d()}]),angular.module("mindmapModule").factory("Utils",function(){return{uuid:function(){var a=(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:c&&7||8).toString(16)});return b}}}),angular.module("mindmapModule").factory("KeyboardUtils",function(){var a={enter:"enter",tab:"tab",shift:"shift",esc:"esc",down:"down",up:"up",left:"left",right:"right"};return{keys:a,9:a.tab,13:a.enter,16:a.shift,27:a.esc,37:a.left,38:a.up,39:a.right,40:a.down}});